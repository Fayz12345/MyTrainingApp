name: Test Android Release APK

on:
  workflow_dispatch:

env:
  AWS_REGION: ca-central-1

jobs:
  test-release-build:
    name: Test Release APK Build
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install dependencies
        run: npm ci

      - name: Setup Android SDK
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platforms;android-34" "build-tools;34.0.0" "ndk;27.1.12297006"

      - name: Create release keystore (temporary for testing)
        run: |
          cd android/app
          # Create a temporary keystore for testing (NOT for production)
          keytool -genkeypair -v -storetype PKCS12 -keystore my-upload-key.keystore \
            -alias my-key-alias -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass android -keypass android \
            -dname "CN=Test,OU=Test,O=Test,L=Test,S=Test,C=US"

      - name: Configure gradle properties for release
        run: |
          cd android
          echo "MYAPP_UPLOAD_STORE_FILE=my-upload-key.keystore" >> gradle.properties
          echo "MYAPP_UPLOAD_KEY_ALIAS=my-key-alias" >> gradle.properties  
          echo "MYAPP_UPLOAD_STORE_PASSWORD=android" >> gradle.properties
          echo "MYAPP_UPLOAD_KEY_PASSWORD=android" >> gradle.properties
          echo "newArchEnabled=false" >> gradle.properties
          echo "hermesEnabled=false" >> gradle.properties

      - name: Update build.gradle for signing
        run: |
          cd android/app
          # Check if signing config already exists
          if ! grep -q "signingConfigs" build.gradle; then
            # Add signing config after android {
            sed -i '/android {/a\
    signingConfigs {\
        release {\
            if (project.hasProperty("MYAPP_UPLOAD_STORE_FILE")) {\
                storeFile file(MYAPP_UPLOAD_STORE_FILE)\
                storePassword MYAPP_UPLOAD_STORE_PASSWORD\
                keyAlias MYAPP_UPLOAD_KEY_ALIAS\
                keyPassword MYAPP_UPLOAD_KEY_PASSWORD\
            }\
        }\
    }' build.gradle
            
            # Update release buildType to use signing config
            sed -i '/release {/,/}/ { 
              /signingConfig/d
              /}/i\            signingConfig signingConfigs.release
            }' build.gradle
          fi

      - name: Build Release APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease --no-daemon --stacktrace
        env:
          GRADLE_OPTS: '-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs="-Xmx4g"'

      - name: Verify Release APK
        run: |
          APK_PATH="android/app/build/outputs/apk/release/app-release.apk"
          if [ -f "$APK_PATH" ]; then
            APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
            echo "✅ Release APK created successfully!"
            echo "📏 Size: $APK_SIZE"
            
            # Check if it's properly signed
            if command -v aapt &> /dev/null; then
              echo "📋 APK Info:"
              aapt dump badging "$APK_PATH" | head -5
            fi
            
            cp "$APK_PATH" "./MyTrainingApp-release.apk"
          else
            echo "❌ Release APK not found"
            echo "🔍 Available files:"
            find android/app/build -name "*.apk" -type f || echo "No APK files"
            exit 1
          fi

      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: android-release-apk-test
          path: MyTrainingApp-release.apk

      - name: Summary
        run: |
          echo "📱 Release APK Test Summary:"
          echo "✅ Successfully built SIGNED release APK"
          echo "⚠️  Uses temporary test keystore (NOT for production)"
          echo "🎯 Next: Create production keystore for real release"